<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title></title>
    <script src="https://pure-refuge-59195.herokuapp.com/dist/crowdin-web-components/crowdin-web-components.js"></script>
    <style type='text/css'>
        .i_w {
            padding: 16px 24px;
            max-width: 1420px;
            margin: 0 auto;
        }

        .center {
            text-align: center;
            min-height: calc(100vh - 64px);
            display: flex;
            align-items: center;
            justify-content: space-around;
        }

        .top {
            text-align: right;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<template id=integration>
    <div class='top'>
    </div>
    <crowdin-simple-integration>
    </crowdin-simple-integration>
</template>
<div class='i_w'>
    <div class="center">
        <div>
            <h1></h1>
            <crowdin-progress-indicator></crowdin-progress-indicator>
        </div>
    </div>
</div>
<crowdin-toasts></crowdin-toasts>
<script type=text/javascript>
  let manifest = {};
  let urlParams = new URLSearchParams(window.location.search);
  let origin = urlParams.get('origin');
  let client_id = urlParams.get('client_id');
  let tokenJwt = urlParams.get('tokenJwt');
 // let tokenJwt = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJ0cmpCYmpBdWUyN3RZN0h3MHBoSCIsInN1YiI6IjEiLCJkb21haW4iOiJ5ZXZoZW4xMTEiLCJjb250ZXh0Ijp7InByb2plY3RfaWQiOiI1In0sImlhdCI6MTU4MjE1NTQwNiwiZXhwIjoxNTgyMTU2MzA2fQ.iq4MLXuvPYbqJU0b8cKWD1WgsYgNo8xtDi1hXVMCO80';
   let restParams = window.location.search;

  // let restParams = `?origin=${origin}&client_id=${client_id}&tokenJwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJ0cmpCYmpBdWUyN3RZN0h3MHBoSCIsInN1YiI6IjEiLCJkb21haW4iOiJ5ZXZoZW4xMTEiLCJjb250ZXh0Ijp7InByb2plY3RfaWQiOiI1In0sImlhdCI6MTU4MjE1NTQwNiwiZXhwIjoxNTgyMTU2MzA2fQ.iq4MLXuvPYbqJU0b8cKWD1WgsYgNo8xtDi1hXVMCO80`;

  let postPromises = {};

  function showToast(message) {
    if(!!message) {
      toasts = document.querySelector('crowdin-toasts');
      if(toasts && toasts.pushToasts) {
        toasts.pushToasts([message]);
      } else {
        setTimeout(() => {
          toasts.pushToasts([message]);
        }, 1000);
      }
    }
  }

  function catchRejection(e, message = undefined) {
    console.log(e);
    document.querySelector('.i_w .center').innerHTML =
      `<crowdin-nothing-to-display
                message="${manifest.name}" 
                sub-message="It's not a problem with crowdin, it's something on app backend"
            ></crowdin-nothing-to-display>`;
    showToast(message);
  }

  function checkResponse(response) {
    return new Promise((resolve, reject) => {
      if(response.status === 204) {
        return resolve();
      }
      response.json()
        .then(res => {
          if(![200, 201].includes(response.status)) {
            reject();
          } else {
            resolve(res);
          }
        })
        .catch(e => {
          reject(e);
        });
    });
  }

  function parseJwt(token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(jsonPayload);
  }

  function parentWindowPostMessage(data) {
    window.parent.postMessage(
      JSON.stringify(data),
      origin
    );
  }

  function checkOrigin() {
    let time = new Date().getTime();
    return new Promise((resolve, reject) => {
      try {
        let tokenData = parseJwt(tokenJwt);
        if(tokenData.exp < parseInt(new Date().getTime() / 1000)) {
          window.tokenJwt = null;

          postPromises[time] = resolve;

          // request for new token
          parentWindowPostMessage({
            client_id: client_id,
            command: 'token',
            uid: time,
            data: {}
          });

        } else {
          resolve(restParams);
        }
      } catch(e) {
        reject();
      }
    });
  }

  if(!origin || !client_id || !tokenJwt) {
    catchRejection(null, 'Request has no origin data (clientId, tokenJWT)');
  }

  (function getManifest() {
    fetch('/manifest.json')
      .then((response) => {
        return checkResponse(response);
      })
      .then((res) => {
        manifest = res;
        document.title = res.name;
        document.querySelector('.i_w h1').innerText = manifest.name;
      })
      .catch(e => {
        catchRejection(e, 'Can\'t fetch manifest.json');
      });
  })();

  function isInstalled() {
    checkOrigin()
      .then(restParams => {
        return fetch('/status' + restParams);
      })
      .then((response) => {
        return checkResponse(response);
      })
      .then((res) => {
        if(!res.isInstalled) {
          document.querySelector('.i_w .center div').innerHTML =
            `<h1>Looks like ${manifest.name} is not installed yet!</h1>
                        <p>Contact your organization administrator to install it. More info on <a href='https://support.crowdin.com'>Link to how to install</a></p>`;
        } else if(!res.isLoggedIn) {
          document.querySelector('.i_w .center div').innerHTML =
            `<crowdin-button primary onclick="integrationLogin()">Loggin with ${manifest.name}</crowdin-button>`;
        } else {
          let el = document.querySelector('.i_w');
          let template = document.getElementById('integration');
          el.innerHTML = '';
          el.appendChild(template.content.cloneNode(true));
          prepareComponent();
        }
      }).catch(e => {
      catchRejection(e, 'Can\'t check instalation status');
    });
  }

  isInstalled();

  function integrationLogin() {
    checkOrigin()
      .then(restParams => {
        return fetch('/integration-login' + restParams);
      })
      .then((response) => {
        return checkResponse(response);
      })
      .then((res) => {
        var left = screen.width / 2 - 300;
        var top = screen.height / 2 - 350;
        var config = 'toolbar=no, menubar=no, width=600, height=700, top=' + top + ', left=' + left;
        window.open(res.url, manifest.name, config);
      }).catch(e => {
      catchRejection(e, 'Can\'t fetch integration login url');
    });
  }

  window.addEventListener('message', handleMessage);

  function handleMessage(event) {
    if(event.data === 'reload') {
      isInstalled();
    } else {
      let eventData = JSON.parse(event.data);
      if(eventData.command === 'token' && event.origin === origin && postPromises[eventData.uid]) {
        restParams = `?origin=${origin}&client_id=${client_id}&tokenJwt=${eventData.data.tokenJwt}`;
        postPromises[eventData.uid](restParams);
      } else if (postPromises[eventData.uid]) {
        postPromises[eventData.uid](eventData.data);
      }
    }
  }

  function prepareComponent() {
    let el = document.querySelector('crowdin-simple-integration');
    document.querySelector('.top').innerHTML = `<crowdin-button outlined onclick="integrationLogOut()">Change ${manifest.name} account</crowdin-button>`;
    el.setAttribute('integration-name', manifest.name);
    el.setAttribute('integration-logo', '/assets/logo.png');
    el.setAttribute('is-crowdin-loading', true);
    el.setAttribute('is-integration-loading', true);
    getIntegrationFiles();
    getCrowdinFiles();
  }

  function getIntegrationFiles() {
    checkOrigin()
      .then(restParams => {
        return fetch('/integration-data' + restParams);
      })
      .then((response) => {
        return checkResponse(response);
      })
      .then((res) => {
        let el = document.querySelector('crowdin-simple-integration');
        el.setIntegrationFilesData(res.map(({title, ...rest}) => ({
          name: title,
          icon: '/assets/logo.png',
          parent_id: 0, ...rest
        })));
        el.setAttribute('is-integration-loading', false);
      }).catch(e => {
      catchRejection(e, 'Can\'t fetch integration files');
    });
  }

  function getCrowdinFiles() {
    checkOrigin()
      .then(restParams => {
        return fetch('/crowdin-data' + restParams)
      })
      .then((response) => {
        return checkResponse(response);
      })
      .then((res) => {
        let el = document.querySelector('crowdin-simple-integration');
        el.setCrowdinFilesData(res.map(({directoryId, branchId, ...rest}) => ({
          ...rest,
          parent_id: directoryId || branchId || 0
        })));
        el.setAttribute('is-crowdin-loading', false);
      }).catch(e => {
      catchRejection(e, 'Can\'t fetch Crowdin files');
    });
  }

  function integrationLogOut() {
    checkOrigin()
      .then(restParams => {
        return fetch('/integration-log-out' + restParams)
      })
      .then((response) => {
        return checkResponse(response);
      })
      .then(res => {
        let el = document.querySelector('.i_w');
        el.innerHTML =
          `<div class='center'><div><crowdin-button primary onclick="integrationLogin()">Loggin with ${manifest.name}</crowdin-button></div></div>`;
        integrationLogin();  // immediately show login form again
      })
      .catch(e => {
        catchRejection(e, 'Looks like you are not logged in');
        window.location.reload();
      })
  }

  function uploadFilesToCrowdin(e) {
    if(e.detail.length === 0) {
      document.querySelector('crowdin-toasts').pushToasts(['Select files that will be uploaded to Crowdin']);
      return;
    }
    const fileIds = event.detail.map(file => file.id);
    let el = document.querySelector('crowdin-simple-integration');
    el.setAttribute('is-to-crowdin-process', true);
    checkOrigin()
      .then(restParams => {
        return fetch('/upload-to-crowdin' + restParams, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(fileIds)
        })
      })
      .then((response) => {
        return checkResponse(response);
      })
      .then(res => {
        showToast('Done');
        el.setAttribute('is-to-crowdin-process', false);
        getCrowdinFiles();
      })
      .catch(e => {
        el.setAttribute('is-to-crowdin-process', false);
        catchRejection(e, 'Can\'t upload files to Crowdin');
      });
  }

  function uploadFilesToIntegration(e) {
    if(e.detail.length === 0) {
      document.querySelector('crowdin-toasts').pushToasts([`Select files that will be uploaded to ${manifest.name}`]);
      return;
    }
    const fileIds = event.detail.map(file => file.name.replace('.json', ''));
    let el = document.querySelector('crowdin-simple-integration');
    el.setAttribute('is-to-integration-process', true);
    checkOrigin()
      .then(restParams => {
        return fetch('/upload-to-integration' + restParams, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(fileIds)
        })
      })
      .then((response) => {
        return checkResponse(response);
      })
      .then(res => {
        showToast('Done');
        el.setAttribute('is-to-integration-process', false);
        getIntegrationFiles();
      })
      .catch(e => {
        el.setAttribute('is-to-integration-process', false);
        catchRejection(e, 'Can\'t upload files to integration');
      });
  }

  document.body.addEventListener('uploadFilesToCrowdin', uploadFilesToCrowdin);
  document.body.addEventListener('uploadFilesToIntegration', uploadFilesToIntegration);
</script>
</body>
</html>